---
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

const productId = Astro.params.id;

const apiUrl = `https://miriam-backend.onrender.com/api/products/${productId}?populate[product_type][on][product-types.komodi][populate][0]=body_material.img&populate[product_type][on][product-types.komodi][populate][1]=front_materials.img&populate[product_type][on][product-types.komodi][populate][2]=images&populate[product_type][on][product-types.komodi][populate][3]=size_option`;

const search = Astro.url.searchParams;
const selectedWidth = Number(search.get("width")) || null;
const selectedHeight = Number(search.get("height")) || null;
const selectedDepth = Number(search.get("depth")) || null;

let product = null;
let productType = null;
let images = [];

try {
  const res = await fetch(apiUrl);
  const json = await res.json();
  product = json.data;
  productType = product?.product_type?.[0] || null;
  images = productType?.images || [];
} catch (error) {
  console.error("Помилка при завантаженні продукту:", error);
}

const allOptions = productType?.size_option || [];

const widths = [...new Set(allOptions.map(o => o.width))];
const heights = [...new Set(allOptions.map(o => o.height))];
const depths = [...new Set(allOptions.map(o => o.depth))];

const validOptions = allOptions.filter(option => {
  return (!selectedWidth || option.width === selectedWidth) &&
         (!selectedHeight || option.height === selectedHeight) &&
         (!selectedDepth || option.depth === selectedDepth);
});

const matched = validOptions.length === 1 ? validOptions[0] : null;

const isOptionDisabled = (param, value) => {
  return !allOptions.some(option => {
    const matchWidth = param === "width" ? option[param] === value : !selectedWidth || option.width === selectedWidth;
    const matchHeight = param === "height" ? option[param] === value : !selectedHeight || option.height === selectedHeight;
    const matchDepth = param === "depth" ? option[param] === value : !selectedDepth || option.depth === selectedDepth;
    return matchWidth && matchHeight && matchDepth;
  });
};

const baseUrl = Astro.url.pathname;

const getUpdatedUrl = (param, value) => {
  const params = new URLSearchParams(search);
  if (Number(params.get(param)) === value) {
    params.delete(param);
  } else {
    params.set(param, value);
  }
  return `${baseUrl}?${params.toString()}`;
};

function getImgUrl(img) {
  if (!img?.url) return "";
  return img.url.startsWith("http")
    ? img.url
    : `https://miriam-backend.onrender.com${img.url}`;
}
---

<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>{productType?.model_name ?? "Деталі товару"}</title>
    <base href="/" />
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700" rel="stylesheet" />
    <link rel="stylesheet" href="/libs/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/libs/nivo-slider/css/nivo-slider.css" />
    <link rel="stylesheet" href="/libs/nivo-slider/css/animate.css" />
    <link rel="stylesheet" href="/libs/nivo-slider/css/style.css" />
    <link rel="stylesheet" href="/libs/font-material/css/material-design-iconic-font.min.css" />
    <link rel="stylesheet" href="/libs/slider-range/css/jslider.css" />
    <link rel="stylesheet" href="/libs/owl-carousel/assets/owl.carousel.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/reponsive.css" />
    <link rel="stylesheet" href="/css/custom.css" />
  </head>
  <body id="product-detail">
    <Header />
    <div class="main-content">
      <div id="wrapper-site">
        <div id="content-wrapper">
          <div id="main">
            <div class="page-home">
              <nav class="breadcrumb-bg">
                <div class="container no-index">
                  <div class="breadcrumb">
                    <ol>
                      <li>
                        <a href="/"><span>Головна</span></a>
                      </li>
                      <li>
                        <a><span>{productType?.model_name}</span></a>
                      </li>
                    </ol>
                  </div>
                </div>
              </nav>

              <div class="container">
                <div class="content">
                  {
                    product ? (
                      <div class="row">
                        <div class="col-sm-12 col-lg-12 col-md-12">
                          <div class="main-product-detail">
                            <h2>{productType?.model_name}</h2>
                            <div class="product-single row">
                              <div class="product-detail col-xs-12 col-md-5 col-sm-5">
                                <div class="page-content" id="content">
                                  <div class="images-container">
                                    <div class="js-qv-mask mask tab-content border">
                                      {images.map((img, i) => (
                                        <div id={`item${i + 1}`} class={`tab-pane fade${i === 0 ? " active in show" : ""}`}>
                                          <img class="main-slider-image" src={getImgUrl(img)} alt={img?.alt || "img"} />
                                        </div>
                                      ))}
                                      <div class="layer hidden-sm-down" data-toggle="modal" data-target="#product-modal">
                                        <i class="fa fa-expand" />
                                      </div>
                                    </div>
                                    {images.length > 1 && (
                                      <ul class="product-tab nav nav-tabs d-flex">
                                        {images.map((img, i) => (
                                          <li class={`${i === 0 ? "active" : ""} col`}>
                                            <a
                                              href={`#item${i + 1}`}
                                              data-toggle="tab"
                                              aria-expanded={i === 0 ? "true" : undefined}
                                              class={i === 0 ? "active show" : undefined}
                                            >
                                              <img src={getImgUrl(img)} alt={img?.alt || "img"} />
                                            </a>
                                          </li>
                                        ))}
                                      </ul>
                                    )}

                                    <!-- MODAL -->
                                    <div class="modal fade" id="product-modal" role="dialog">
                                      <div class="modal-dialog">
                                        <div class="modal-content">
                                          <div class="modal-header"></div>
                                          <div class="modal-body">
                                            <div class="product-detail">
                                              <div class="images-container">
                                                <div class="js-qv-mask mask tab-content">
                                                  {images.map((img, i) => (
                                                    <div id={`modal-item${i + 1}`} class={`tab-pane fade${i === 0 ? " active in show" : ""}`}>
                                                      <img src={getImgUrl(img)} alt={img?.alt || "img"} />
                                                    </div>
                                                  ))}
                                                </div>
                                                {images.length > 1 && (
                                                  <ul class="product-tab nav nav-tabs">
                                                    {images.map((img, i) => (
                                                      <li class={i === 0 ? "active" : ""}>
                                                        <a
                                                          href={`#modal-item${i + 1}`}
                                                          data-toggle="tab"
                                                          class={i === 0 ? "active show" : undefined}
                                                        >
                                                          <img src={getImgUrl(img)} alt={img?.alt || "img"} />
                                                        </a>
                                                      </li>
                                                    ))}
                                                  </ul>
                                                )}
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    <!-- /MODAL -->
                                  </div>
                                </div>
                              </div>

                              <div class="product-info col-xs-12 col-md-7 col-sm-7">
                                <div class="detail-description">
                                  <div class="price-del">
                                    {
                                      matched ? (
                                        <span class="price">₴{matched.price}</span>
                                      ) : (
                                        <span class="price">₴{productType?.basic_price}</span>
                                      )
                                    }
                                    <span class="float-right">
                                      <span class="availb">Наявність: </span>
                                      <span class="check"><i class="fa fa-check-square-o" /> На складі</span>
                                    </span>
                                  </div>

                                  <div class="option has-border d-lg-flex size-color">
                                    <div>
                                      <h6>Оберіть розміри:</h6>
                                      <small class="text-muted d-block mb-3">Натисніть ще раз, щоб скасувати вибір</small>
                                      <strong>Ширина</strong>
                                      <div class="grid">
                                        {widths.map(w => (
                                          <a
                                            href={getUpdatedUrl('width', w)}
                                            class={`cube ${selectedWidth === w ? 'active' : ''} ${isOptionDisabled('width', w) ? 'disabled' : ''}`}
                                          >{w}</a>
                                        ))}
                                      </div>

                                      <strong>Висота</strong>
                                      <div class="grid">
                                        {heights.map(h => (
                                          <a
                                            href={getUpdatedUrl('height', h)}
                                            class={`cube ${selectedHeight === h ? 'active' : ''} ${isOptionDisabled('height', h) ? 'disabled' : ''}`}
                                          >{h}</a>
                                        ))}
                                      </div>

                                      <strong>Глибина</strong>
                                      <div class="grid">
                                        {depths.map(d => (
                                          <a
                                            href={getUpdatedUrl('depth', d)}
                                            class={`cube ${selectedDepth === d ? 'active' : ''} ${isOptionDisabled('depth', d) ? 'disabled' : ''}`}
                                          >{d}</a>
                                        ))}
                                      </div>
                                    </div>
                                  </div>

                                  {productType?.body_material?.length > 0 && (
                                    <div class="option has-border mt-4">
                                      <h5 class="text-danger">Колір корпусу</h5>
                                      <div class="row">
                                        {productType.body_material.map((item) => (
                                          <div class="col-3 col-sm-2 text-center mb-4">
                                            {item.img?.url ? (
                                              <div class="color-box">
                                                <img src={getImgUrl(item.img)} alt={item.title} class="img-fluid border" />
                                              </div>
                                            ) : (
                                              <div class="color-box border d-flex align-items-center justify-content-center" style="height:100px;background:#f8f8f8">
                                                <span class="text-muted small">—</span>
                                              </div>
                                            )}
                                            <div class="mt-1 small">{item.title}</div>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}

                                  {productType?.front_materials?.length > 0 && (
                                    <div class="option has-border mt-4">
                                      <h5 class="text-danger">Колір фасадів</h5>
                                      <div class="row">
                                        {productType.front_materials.map((item) => (
                                          <div class="col-3 col-sm-2 text-center mb-4">
                                            {item.img?.url ? (
                                              <div class="color-box">
                                                <img src={getImgUrl(item.img)} alt={item.title} class="img-fluid border" />
                                              </div>
                                            ) : (
                                              <div class="color-box border d-flex align-items-center justify-content-center" style="height:100px;background:#f8f8f8">
                                                <span class="text-muted small">—</span>
                                              </div>
                                            )}
                                            <div class="mt-1 small">{item.title}</div>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}

                                  <div class="has-border cart-area">
                                    <div class="product-quantity">
                                      <div class="qty">
                                        <div class="input-group">
                                          <div class="quantity">
                                            <span class="control-label">Кількість : </span>
                                            <input type="text" name="qty" id="quantity_wanted" value="1" class="input-group form-control" />
                                            <span class="input-group-btn-vertical">
                                              <button class="btn btn-touchspin js-touchspin bootstrap-touchspin-up" type="button">
                                                +
                                              </button>
                                              <button class="btn btn-touchspin js-touchspin bootstrap-touchspin-down" type="button">
                                                -
                                              </button>
                                            </span>
                                          </div>
                                          <span class="add">
                                            <button class="btn btn-primary add-to-cart add-item" data-button-action="add-to-cart" type="submit">
                                              <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                                              <span>До кошика</span>
                                            </button>
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="clearfix"></div>
                                    <p class="product-minimal-quantity"></p>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="review">
                              <ul class="nav nav-tabs">
                                <li class="active">
                                  <a data-toggle="tab" href="#description" class="active show">Опис</a>
                                </li>
                              </ul>
                              <div class="tab-content">
                                <div id="description" class="tab-pane fade in active show">
                                  <p>{productType?.furniture_description}</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <p>Товар не знайдено.</p>
                    )
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <Footer />
    <script src="/libs/jquery/jquery.min.js" is:inline></script>
    <script src="/libs/popper/popper.min.js" is:inline></script>
    <script src="/libs/bootstrap/js/bootstrap.min.js" is:inline></script>
    <script src="/libs/nivo-slider/js/jquery.nivo.slider.js" is:inline></script>
    <script src="/libs/owl-carousel/owl.carousel.min.js" is:inline></script>
    <script src="/libs/slider-range/js/tmpl.js" is:inline></script>
    <script src="/libs/slider-range/js/jquery.dependClass-0.1.js" is:inline></script>
    <script src="/libs/slider-range/js/draggable-0.1.js" is:inline></script>
    <script src="/libs/slider-range/js/jquery.slider.js" is:inline></script>
    <script src="/js/theme.js" is:inline></script>
  </body>
</html>
