---
// src/pages/checkout.astro
export const prerender = false;

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

// ===== Конфіг із .env ========================================================
const API_BASE =
  import.meta.env.PUBLIC_STRAPI_URL || "https://miriam-backend.onrender.com";
const API_TOKEN = import.meta.env.PUBLIC_STRAPI_TOKEN || ""; // публічний токен (orders.create)

// Безпечний JSON для <script type="application/json">
const safeJson = (o: any) => JSON.stringify(o).replace(/</g, "\\u003c");

// ===== Типи ==================================================================
type Size = {
  width?: number | null;
  height?: number | null;
  depth?: number | null;
  id?: number;
};
type Opt = { id: number; title?: string; img?: string };
type Selection = {
  productId: string | number;
  model_name?: string | null;
  qty?: number;
  size?: Size | null;
  body_material?: Opt | null;
  front_material?: Opt | null;
  base_price?: number | null;
  unit_price?: number | null;
  total_price?: number | null;
  product_img?: string | null;
};
type CartItem = {
  key: string;
  qty: number;
  selection: Selection;
  addedAt: string;
};

// ===== Кошик з cookie ========================================================
let cart: CartItem[] = [];
try {
  cart = JSON.parse(Astro.cookies.get("cart")?.value || "[]");
} catch {}

// Формуємо позиції та підсумки
const items = cart.map((i) => {
  const s = i.selection || {};
  const qty = Number(i.qty || s.qty || 1);
  const unit = Number(s.unit_price ?? s.base_price ?? 0);
  return {
    productId: s.productId ?? "",
    model_name: s.model_name ?? "",
    qty,
    unit_price: unit,
    line_total: unit * qty,
    size: s.size ?? null,
    body_material: s.body_material ?? null,
    front_material: s.front_material ?? null,
    product_img: s.product_img ?? null,
  };
});
const subtotal = items.reduce((a, b) => a + b.line_total, 0);
const itemsCount = items.reduce((a, b) => a + b.qty, 0);
const fmtUA = (n: number) => n.toLocaleString("uk-UA");

// Дані в клієнт
const CHECKOUT_JSON = safeJson({ api: API_BASE, token: API_TOKEN, items });
---

<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <title>Оформлення замовлення</title>
    <link rel="stylesheet" href="/libs/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/checkout.css" />
  </head>

  <body class="product-checkout checkout-cart">
    <Header />
    <div id="checkout" class="main-content mt-5">
      <div class="container">
        <h1 class="h3 mb-4">Оформлення замовлення</h1>

        <div class="row">
          <!-- Форма -->
          <div class="col-lg-8">
            <form id="checkoutForm" class="needs-validation" novalidate>
              <h2 class="h5 section-title">Контактні дані</h2>

              <div class="mb-3">
                <label class="form-label">Ім’я *</label>
                <input
                  type="text"
                  class="form-control"
                  name="first_name"
                  required
                />
                <div class="invalid-feedback">Вкажіть ім’я.</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Прізвище *</label>
                <input
                  type="text"
                  class="form-control"
                  name="last_name"
                  required
                />
                <div class="invalid-feedback">Вкажіть прізвище.</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Електронна пошта *</label>
                <input
                  type="email"
                  class="form-control"
                  name="email"
                  required
                />
                <div class="invalid-feedback">Вкажіть коректний email.</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Телефон *</label>
                <input type="tel" class="form-control" name="phone" required />
                <div class="invalid-feedback">
                  Вкажіть телефон у форматі +380...
                </div>
              </div>

              <h2 class="h5 section-title">Спосіб доставки</h2>
              <div class="mb-3">
                <label class="form-label">Оберіть спосіб</label>
                <select
                  class="custom-select"
                  name="delivery_method"
                  id="deliverySelect"
                >
                  <option value="courier_kyiv" selected
                    >Кур’єр по Київській області</option
                  >
                  <option value="nova_poshta">Нова Пошта</option>
                  <option value="pickup">Самовивіз</option>
                </select>
              </div>

              <!-- Кур’єр -->
              <div class="mb-3" id="addressGroup">
                <label class="form-label">Адреса доставки</label>
                <input
                  type="text"
                  class="form-control"
                  name="delivery_address"
                  placeholder="вул. Прикладна, 1"
                />
                <div class="invalid-feedback">Вкажіть адресу для кур’єра.</div>
                <div class="form-note">Заповнюйте, якщо обрали кур’єра.</div>
              </div>

              <!-- Нова Пошта -->
              <div class="np-row" id="npRow">
                <div class="mb-3">
                  <label class="form-label">Місто (Нова Пошта)</label>
                  <input
                    type="text"
                    class="form-control"
                    name="np_city"
                    placeholder="Київ"
                  />
                  <div class="invalid-feedback">Вкажіть місто.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Відділення (Нова Пошта)</label>
                  <input
                    type="text"
                    class="form-control"
                    name="np_branch"
                    placeholder="Відділення №..."
                  />
                  <div class="invalid-feedback">Вкажіть відділення.</div>
                </div>
              </div>

              <h2 class="h5 section-title">Метод оплати</h2>
              <div class="mb-2 form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="payment_method"
                  id="payBank"
                  value="bank_transfer"
                  checked
                />
                <label class="form-check-label" for="payBank"
                  >Оплата через Р/Р</label
                >
              </div>
              <div class="mb-3 form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="payment_method"
                  id="payCOD"
                  value="cod"
                />
                <label class="form-check-label" for="payCOD"
                  >Готівкою при отриманні</label
                >
              </div>

              <div class="mb-3 form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="prepayment_agreement"
                  id="prepay"
                  checked
                />
                <label class="form-check-label" for="prepay"
                  >Я погоджуюсь з умовами 30% передоплати</label
                >
              </div>

              <div class="mb-4">
                <label class="form-label">Коментар</label>
                <textarea
                  class="form-control"
                  name="comment"
                  rows="4"
                  placeholder="Ваші побажання..."></textarea>
              </div>

              <div class="d-flex align-items-center">
                <a href="/cart" class="btn btn-outline-secondary mr-2"
                  >Назад до кошика</a
                >
                <button class="btn btn-dark" type="submit"
                  >Підтвердити замовлення</button
                >
              </div>
            </form>
          </div>

          <!-- Права колонка -->
          <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="summary-card">
              <div class="h5 mb-3">У кошику {itemsCount} шт.</div>

              {
                items.map((item) => (
                  <div class="summary-item">
                    <img
                      src={item.product_img || "/img/product/placeholder.jpg"}
                      alt={item.model_name}
                    />
                    <div class="summary-details">
                      <div class="item-title">{item.model_name}</div>
                      <div class="item-price">
                        ₴{fmtUA(item.unit_price)} × {item.qty} = ₴
                        {fmtUA(item.line_total)}
                      </div>
                      {item.size && (
                        <div class="item-attr">
                          Розмір: {item.size.width} × {item.size.height} ×{" "}
                          {item.size.depth} мм
                        </div>
                      )}
                      {item.body_material && (
                        <div class="item-attr">
                          Корпус: {item.body_material.title}
                        </div>
                      )}
                      {item.front_material && (
                        <div class="item-attr">
                          Фасади: {item.front_material.title}
                        </div>
                      )}
                    </div>
                  </div>
                ))
              }

              <div class="totals">
                <div>Разом за товари: ₴{fmtUA(subtotal)}</div>
                <div class="fw-bold">Всього: ₴{fmtUA(subtotal)}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div class="toast-wrap" aria-live="polite" aria-atomic="true">
      <div
        id="toast"
        class="toast-lite"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="title"></div>
        <div class="msg"></div>
      </div>
    </div>

    <Footer />

    <!-- Дані для клієнта -->
    <script
      type="application/json"
      id="checkout-data"
      set:html={CHECKOUT_JSON}
    />

    <script src="/js/checkout.js" defer></script>
  </body>
</html>
